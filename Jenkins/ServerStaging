pipeline {
 agent any
 environment {
  dotnet = "C:/Program Files/dotnet/dotnet.exe"
  appcmd = "C:/Windows/System32/inetsrv/appcmd.exe"
  
  destFolder = "C:/projects/PTMS"
  dbCreatorFolder = "${destFolder}/PTMS-DbCreator"  
  serverFolderName = "PTMS-Server"
  serverFolder = "${destFolder}/${serverFolderName}"
  tempServerFolder = "${destFolder}/PTMS-Server-Temp"
  configFolder = "${destFolder}/Configs"
 }
 stages {
  stage("Build DbCreator") {
   steps {
	bat "rmdir /s/q \"${dbCreatorFolder}\" 2>nul"
    bat "cd PTMS.Server & dotnet publish PTMS.DbCreator -r win-x64 --self-contained -c Release -o ${dbCreatorFolder}"
	bat "xcopy /s/y ${configFolder}/appsettings.json ${dbCreatorFolder}"
   }
  }
  stage("Build Server into TempFolder") {
   steps {
	bat "rmdir /s/q \"${tempServerFolder}\" 2>nul"
    bat "cd PTMS.Server & dotnet publish PTMS.Api -c Release -o ${tempServerFolder}"
   }
  }
  stage("Run DbCreator") {
   steps {
    bat "${dbCreatorFolder}/PTMS.DbCreator.exe"
	bat "rmdir /s/q \"${dbCreatorFolder}\" 2>nul"
   }
  }
  stage("Apply Server Build") {
   steps {
	bat "rmdir /s/q \"${serverFolder}\" 2>nul"
    bat "move ${tempServerFolder} ${serverFolder}"
	bat "xcopy /s/y ${configFolder}/appsettings.json ${serverFolder}"
   }
  }
  stage("Restart IIS Site") {
   steps {
	bat "appcmd stop site PtmsServer"
    bat "appcmd start site PtmsServer"
   }
  }
 }
}